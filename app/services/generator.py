"""문서 생성 LLM 서비스 (Gemini)"""

import re
import google.generativeai as genai
from typing import List, Dict, Any, Tuple
from datetime import datetime
import uuid

from app.config import settings
from app.services.vector_service import vector_service


# ================================================================================
# 공통 기본 가이드라인 (모든 데이터셋 공통)
# ================================================================================
BASE_GUIDELINE = """
================================================================================
철도 시설물 결함 위험등급 판정 기본 원칙
================================================================================

【위험등급 정의】
┌─────────┬─────────────────────────┬─────────────────────────────┬─────────────────┐
│ 등급    │ 명칭                    │ 안전 영향                   │ 조치 필요       │
├─────────┼─────────────────────────┼─────────────────────────────┼─────────────────┤
│ E       │ 정상 상태               │ 영향 없음                   │ 정기 점검만     │
│ O       │ 요주의 결함             │ 경미한 결함                 │ 모니터링 단계   │
│ X1      │ 중·장기 파손 발전 가능  │ 중·장기적 파손 가능         │ 1개월 이내 교체 │
│ X2      │ 단기 파손 발전          │ 단기간 파손 가능            │ 10일 이내 교체  │
│ S       │ 즉각 파손 위험          │ 즉각적 사고 위험            │ 즉시 교체(당일) │
└─────────┴─────────────────────────┴─────────────────────────────┴─────────────────┘

【신뢰도 구간별 기본 등급】
┌─────────────────┬─────────────────────┐
│ 신뢰도 구간    │ 허용 위험 등급      │
├─────────────────┼─────────────────────┤
│ 0~25%          │ E, O                │
│ 25%~50%        │ O, X1               │
│ 50%~75%        │ X1, X2              │
│ 75%~100%       │ X2, S               │
└─────────────────┴─────────────────────┘

【정상 신뢰도 우선 원칙】
- 정상 신뢰도 ≥ 75% + 모든 결함 < 25% → E등급
- 정상 신뢰도 ≥ 75% + 결함 ≥ 25% 존재 → 최대 O등급
- 정상 신뢰도 < 50% → 최고 결함 신뢰도 기준 판정

【경계 케이스 처리】
■ Case A: 신뢰도 25% 정확히 경계
  - 예: 훼손 25.0%
  - 판정: 25~50% 구간으로 처리 (상위 구간 적용)
  - 이유: 보수적 접근 (안전 우선)

■ Case B: 신뢰도 75% 세분화 경계
  - 예: 훼손 75.0% (선로 데이터셋)
  - 판정: 75~85% 구간 → X2등급
  - 이유: 선로-훼손 75~85%는 X2, 85% 이상은 S

■ Case C: 다수 낮은 결함 + 높은 정상
  - 예: 정상 78%, 훼손 15%, 풀림 7%
  - 판정: E등급 (정상)
  - 이유: 정상 우선 원칙 적용
  - 비고: "미세 결함 징후 있음" 추적용 표기

【한계 및 인간 감독의 중요성】
본 AI 평가 시스템의 본질적 한계:
1. 모델 불확실성: 신뢰도 점수는 모델 예측이며 절대적 진실이 아님
2. 맥락 한계: AI는 운영 이력, 유지보수 기록, 현장 조건을 고려할 수 없음
3. 경계 케이스: 임계값 근처의 점수는 인간 판단 필요
※ 고위험 등급(X2, S) 또는 재평가 표시된 케이스는 반드시 현장 점검자 확인 필요
"""

# ================================================================================
# 철도 선로 전용 가이드라인
# ================================================================================
RAIL_GUIDELINE = """
================================================================================
【철도 선로 유지보수 규정 시나리오】
================================================================================
점검 대상: 침목, 절연블록, 나사스파이크, 레일, 볼트너트, 용접부, 이음매판,
          레일체결장치 (FASTclip, system300-1, 팬드롤 e-clip)

■ 분류 등급(E): 정상 상태
  • 결함 상태: 훼손 없음, 너트 풀림 없음
  • 안전 영향: 없음
  • 교체 기간: 해당 없음

■ 분류 등급(O): 요주의 결함
  • 결함 상태: 경미한 표면 훼손, 초기 단계 너트 풀림
  • 안전 영향: 보강 없이 열차 주행 가능
  • 교체 기간: 모니터링 단계 (즉시 교체 불필요)

■ 분류 등급(X1): 중·장기 파손 발전 가능 결함
  • 결함 상태: 레일/체결부 훼손 명확, 너트 풀림 반복 관측
  • 안전 영향: 궤도 안정성 저하 가능성
  • 교체 기간: 1개월 이내 교체 필요

■ 분류 등급(X2): 단기 파손 발전 결함
  • 결함 상태: 훼손 범위 확대, 다수 너트 풀림/체결 기능 상실
  • 안전 영향: 단기간 내 레일 이탈 가능성
  • 교체 기간: 10일 이내 교체 필요

■ 분류 등급(S): 파손 또는 즉각 파손 위험
  • 결함 상태: 레일 파손, 너트 탈락, 체결 기능 상실
  • 안전 영향: 즉각적 탈선 및 사고 위험
  • 교체 기간: 즉시 교체 (당일 교체 원칙)

[신뢰도-등급 매핑]
- 0~25%: E등급 | 25~50%: O등급 | 50~75%: X1등급 | 75~85%: X2등급 | 85~100%: S등급
"""

# ================================================================================
# 전차선 애자 전용 가이드라인
# ================================================================================
INSULATOR_GUIDELINE = """
================================================================================
【전차선 애자 유지보수 규정 시나리오】
================================================================================
점검 대상: 애자류, 클램프류, 행거류, 프로텍터류
결함 종류: 균열&파손, 이탈, 마모, 탈락, 파손, 마모&커버탈락

■ 분류 등급(E): 정상 상태
  • 결함 유형: 없음
  • 안전 영향: 없음
  • 조치: 교체 불필요, 정기 점검 유지

■ 분류 등급(O): 경미 결함
  • 결함 유형: 미세 균열, 미세 마모
  • 안전 영향: 현재 성능 저하 없음, 장기적 진행 가능
  • 조치: 모니터링 단계, 추적 점검 강화

■ 분류 등급(X1): 중·장기 파손 발전 가능 결함
  • 결함 유형: 부분 이탈, 마모 및 커버 탈락 진행, 일부 파손
  • 안전 영향: 장기적 구조적 강도 저하 가능
  • 조치: 1개월 이내 교체 또는 보수 권장

■ 분류 등급(X2): 단기 파손 발전 결함
  • 결함 유형: 중간 이상 균열/파손, 탈락 진행 징후
  • 안전 영향: 구조 붕괴 가능성, 전차선 이탈 위험
  • 조치: 10일 이내 교체 권장

■ 분류 등급(S): 즉각적 위험 상태
  • 결함 유형: 완전 파손, 기능 상실, 즉시 붕괴 가능
  • 안전 영향: 즉각적 사고 위험, 전차선 단선/이탈
  • 조치: 즉시 교체 (당일 교체 원칙)

[신뢰도-등급 매핑]
- 0~25%: E등급 | 25~50%: O등급 | 50~75%: X1등급 | 75~100%: X2 또는 S등급
"""

# ================================================================================
# 둥지류 전용 가이드라인
# ================================================================================
NEST_GUIDELINE = """
================================================================================
【둥지류 규정 시나리오】
================================================================================
점검 대상: 조류 둥지
위험 기준: 둥지로 인해 철도 설비 및 애자에 발생할 수 있는 안전 영향

■ 분류 등급(E): 둥지 미탐지
  • 둥지 상태: 둥지 미형성 또는 흔적 없음
  • 안전 영향: 없음
  • 조치: 해당 없음

■ 분류 등급(O): 소형 둥지, 안전한 위치
  • 둥지 상태: 소형 둥지, 설비 외측/충분한 이격 거리
  • 안전 영향: 현재 설비 간섭 없음
  • 조치: 모니터링 단계 (즉시 제거 불필요)

■ 분류 등급(X1): 중·장기 모니터링 필요
  • 둥지 상태: 중·대형 둥지, 전차선·애자 인근 위치
  • 안전 영향: 장기적 설비 간섭, 절연 성능 저하 가능
  • 조치: 1개월 이내 제거 필요

■ 분류 등급(X2): 단기 제거 필요
  • 둥지 상태: 둥지 처짐/기울어짐, 설비 이격 거리 급감
  • 안전 영향: 단기간 내 설비 접촉, 전기적 장애 가능
  • 조치: 10일 이내 제거 필요

■ 분류 등급(S): 즉시 제거 (사고위험)
  • 둥지 상태: 둥지 붕괴/낙하, 설비 직접 접촉
  • 안전 영향: 즉시 전력 장애, 운행 중단, 사고 위험
  • 조치: 즉시 제거 (당일 제거 원칙)

[신뢰도-등급 매핑]
- 정상 75~100%: E등급 | 결함 0~25%: O등급 | 25~50%: X1등급 | 50~75%: X2등급 | 75~100%: S등급
"""


class DocumentGenerator:
    """Google Gemini 기반 문서 생성 서비스"""

    def __init__(self):
        genai.configure(api_key=settings.google_api_key)
        self.model = genai.GenerativeModel(settings.gemini_model)
        self.threshold = settings.rag_threshold

    def _get_guideline_for_folder(self, folder: str) -> str:
        """폴더 타입에 맞는 가이드라인 반환"""
        guidelines = {
            'rail': RAIL_GUIDELINE,
            'insulator': INSULATOR_GUIDELINE,
            'nest': NEST_GUIDELINE
        }
        return BASE_GUIDELINE + guidelines.get(folder, RAIL_GUIDELINE)

    def _fix_line_breaks(self, text: str) -> str:
        """숫자/퍼센트/괄호 관련 잘못된 줄바꿈 수정 - 강화 버전"""

        # ===== 1단계: 숫자 중간 줄바꿈 수정 =====
        # "75.\n6%" → "75.6%"
        text = re.sub(r'(\d+)\.\s*\n\s*(\d+)', r'\1.\2', text)

        # ===== 2단계: 괄호 관련 줄바꿈 제거 =====
        # 여는 괄호 직후 줄바꿈 제거
        text = re.sub(r'\(\s*\n\s*', '(', text)
        # 닫는 괄호 직전 줄바꿈 제거
        text = re.sub(r'\s*\n\s*\)', ')', text)

        # 괄호 안 모든 줄바꿈 제거 (여러 번 반복)
        def fix_parentheses(match):
            return re.sub(r'\s*\n\s*', ' ', match.group(0))
        for _ in range(5):
            text = re.sub(r'\([^)]*\n[^)]*\)', fix_parentheses, text)

        # ===== 3단계: 닫는 괄호 뒤 줄바꿈 + 한글 =====
        # "26.1°C)\n는" → "26.1°C)는"
        text = re.sub(r'\)\s*\n\s*([가-힣])', r')\1', text)

        # ===== 4단계: 숫자/단위 뒤 줄바꿈 + 한글 (핵심) =====
        # "26.1°C\n는" → "26.1°C는"
        text = re.sub(r'(\d+\.?\d*°C)\s*\n\s*([가-힣])', r'\1\2', text)
        # "58%\n는" → "58%는"
        text = re.sub(r'(\d+\.?\d*%)\s*\n\s*([가-힣])', r'\1\2', text)
        # "26.1\n°C" → "26.1°C"
        text = re.sub(r'(\d+\.?\d*)\s*\n\s*(°C)', r'\1\2', text)

        # ===== 5단계: 한글 뒤 줄바꿈 + 숫자 =====
        # "온도\n26.1" → "온도 26.1"
        text = re.sub(r'([가-힣])\s*\n\s*(\d)', r'\1 \2', text)
        # "온도,\n26.1" → "온도, 26.1"
        text = re.sub(r'([가-힣]),\s*\n\s*(\d)', r'\1, \2', text)

        # ===== 6단계: 숫자 뒤 줄바꿈 + 한글 (일반) =====
        # "10일\n이내" → "10일 이내"
        text = re.sub(r'(\d+일)\s*\n\s*([가-힣])', r'\1 \2', text)
        # "1개월\n이내" → "1개월 이내"
        text = re.sub(r'(\d+개월)\s*\n\s*([가-힣])', r'\1 \2', text)
        # "2개소\n교체" → "2개소 교체"
        text = re.sub(r'(\d+개소?)\s*\n\s*([가-힣])', r'\1 \2', text)

        # ===== 7단계: 특수 패턴 =====
        # "신뢰도\n75.6%" → "신뢰도 75.6%"
        text = re.sub(r'신뢰도\s*\n\s*(\d)', r'신뢰도 \1', text)
        # "68.3%,\n66.9%" → "68.3%, 66.9%"
        text = re.sub(r'(\d+\.?\d*%)\s*,\s*\n\s*(\d)', r'\1, \2', text)
        # "(60.9%~\n69.2%)" → "(60.9%~69.2%)"
        text = re.sub(r'(\d+\.?\d*%)\s*~\s*\n\s*(\d)', r'\1~\2', text)

        # ===== 8단계: 콜론/쉼표 뒤 줄바꿈 =====
        # "날씨:\n흐림" → "날씨: 흐림"
        text = re.sub(r':\s*\n\s*([가-힣])', r': \1', text)
        # ",\n26.1" → ", 26.1"
        text = re.sub(r',\s*\n\s*(\d)', r', \1', text)

        # ===== 9단계: 리스트 항목 줄바꿈 =====
        # "- \n항목" → "- 항목"
        text = re.sub(r'-\s*\n\s*(\w)', r'- \1', text)

        # ===== 10단계: 연속 빈 줄 정리 =====
        text = re.sub(r'\n{3,}', '\n\n', text)

        # ===== 11단계: 최종 safety net - 숫자 앞뒤 줄바꿈 전부 제거 =====
        # 숫자 바로 앞 줄바꿈 (한글 뒤): "현재\n26" → "현재 26"
        text = re.sub(r'([가-힣a-zA-Z])\s*\n\s*(\d+\.?\d*)', r'\1 \2', text)
        # 숫자+단위 바로 뒤 줄바꿈 (한글 앞): "26.1°C\n의" → "26.1°C의"
        text = re.sub(r'(\d+\.?\d*[°%]?C?)\s*\n\s*([가-힣])', r'\1\2', text)

        return text

    def generate(
        self,
        vision_result: Dict[str, Any],
        use_rag: bool = True,
        metadata: Dict[str, Any] = None,
        folder: str = 'rail'
    ) -> Tuple[str, List[str], bool]:
        """
        문서 생성

        Args:
            vision_result: Vision 모델 결과
            use_rag: RAG 사용 여부
            metadata: 환경 메타데이터 (선택)
            folder: 데이터셋 폴더 타입 ('rail', 'insulator', 'nest')

        Returns:
            (생성된 문서, 참조된 규정 ID 목록, RAG 사용 여부)
        """
        detections = vision_result.get('detections', [])
        referenced_regulations = []
        rag_context = ""

        # RAG로 관련 규정 검색
        if use_rag and detections:
            query = self._build_rag_query(vision_result)
            chunks = vector_service.search(query, top_k=settings.rag_top_k)

            if chunks:
                rag_context = self._format_rag_context(chunks)
                referenced_regulations = list(set(
                    c['regulation_id'] for c in chunks if c.get('regulation_id')
                ))

        # 프롬프트 구성 (folder별 가이드라인 적용)
        prompt = self._build_prompt(vision_result, rag_context, metadata, folder)

        # Gemini API 호출
        response = self.model.generate_content(
            prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.2,
                max_output_tokens=12000  # 8000 → 12000 (긴 보고서 대응)
            )
        )

        document = response.text

        # 후처리: 줄바꿈 수정
        document = self._fix_line_breaks(document)

        return document, referenced_regulations, bool(rag_context)

    def _build_rag_query(self, vision_result: Dict) -> str:
        """RAG 검색용 쿼리 생성"""
        detections = vision_result.get('detections', [])
        query_parts = []

        for det in detections:
            cls_name = det.get('cls_name', '')
            detail = det.get('detail', '')
            rail_type = det.get('rail_type', '')

            if cls_name and detail:
                query_parts.append(f"{cls_name} {detail}")
            if rail_type:
                query_parts.append(rail_type)

        return " ".join(query_parts) if query_parts else "철도 결함 점검"

    def _format_rag_context(self, chunks: List[Dict]) -> str:
        """RAG 검색 결과를 컨텍스트 문자열로 포맷"""
        context_parts = []

        for i, chunk in enumerate(chunks, 1):
            reg_id = chunk.get('regulation_id', 'Unknown')
            content = chunk.get('content', '')
            context_parts.append(f"[규정 {reg_id}]\n{content}")

        return "\n\n".join(context_parts)

    def _build_prompt(self, vision_result: Dict, rag_context: str, metadata: Dict = None, folder: str = 'rail') -> str:
        """LLM 프롬프트 구성"""
        detections = vision_result.get('detections', [])
        image_file = vision_result.get('image_file', 'Unknown')
        is_anomaly = vision_result.get('is_anomaly', False)
        노선 = vision_result.get('노선', '')
        위치 = vision_result.get('위치', '')

        # 메타데이터 추출
        env_metadata = metadata.get('metadata', {}) if metadata else {}
        region_name = env_metadata.get('region_name', '-')
        datetime_str = env_metadata.get('datetime', '-')
        weather = env_metadata.get('weather', '-')
        temperature = env_metadata.get('temperature', '-')
        humidity = env_metadata.get('humidity', '-')

        # 파일명에서 정보 추출
        file_parts = image_file.replace('.jpg', '').split('_')
        if len(file_parts) >= 4:
            rail_type_from_file = file_parts[1] if len(file_parts) > 1 else ''
            location_from_file = file_parts[3] if len(file_parts) > 3 else ''
            if not 노선:
                노선 = rail_type_from_file
            if not 위치:
                위치 = location_from_file

        # 일련번호 생성
        serial_number = f"RPT-{datetime.now().strftime('%Y%m%d')}-{uuid.uuid4().hex[:6].upper()}"

        # 철도분류 결정
        rail_types = set(d.get('rail_type', '') for d in detections)
        철도분류 = ', '.join(rail_types) if rail_types else 노선

        # 부품명 목록
        parts = set(d.get('cls_name', '') for d in detections)
        부품명 = ', '.join(parts) if parts else 'Unknown'

        # 폴더별 가이드라인 가져오기
        guideline = self._get_guideline_for_folder(folder)

        prompt = f"""당신은 철도 시설물 점검 보고서를 작성하는 전문가입니다.
아래 Vision AI 탐지 결과와 관련 규정을 참고하여 점검 보고서를 작성해주세요.

**[중요] 아래 위험등급 판정 가이드라인을 반드시 숙지하고 위험도 등급을 판정하세요.**

{guideline}

## Vision AI 탐지 결과
- 이미지 파일: {image_file}
- 이상 탐지 여부: {'예' if is_anomaly else '아니오'}
- 탐지된 결함 수: {len(detections)}개

## 환경 조건 (메타데이터):
- 지역: {region_name}
- 촬영일시: {datetime_str}
- 날씨: {weather}
- 대기온도: {temperature}°C
- 습도: {humidity}%

### 탐지 상세:
"""
        for i, det in enumerate(detections, 1):
            prompt += f"""
{i}. 부품: {det.get('cls_name', 'Unknown')}
   - 철도유형: {det.get('rail_type', 'Unknown')}
   - 결함상태: {det.get('detail', 'Unknown')}
   - 신뢰도: {det.get('confidence', 0):.1%}
"""

        if rag_context:
            prompt += f"""

## 관련 규정 (RAG 검색 결과):
{rag_context}
"""

        prompt += f"""

## 보고서 작성 요청

아래 형식에 맞춰 보고서를 작성해주세요.

================================================================================
★★★ [권장 조치내용] 작성 규칙 (필수 준수) ★★★
================================================================================

**[조치 방법] 형식을 반드시 준수하세요:**

```
[권장 조치내용]
1. 교체 시기: (위험도 등급에 맞는 기간)
2. 조치 방법:
- [부품명] ([등급], [참조규정ID]): [조치 내용]
- [부품명] ([등급], [참조규정ID]): [조치 내용]
3. 주의사항: (환경 조건 고려)
```

**필수 규칙:**
1. 모든 조치 항목은 반드시 "- [부품명] ([등급], [참조규정ID]): [상세설명]" 형식으로 작성
2. [등급]은 반드시 E/O/X1/X2/S 중 하나만 표기 (복수 등급 금지: X2/X1 이런 식 금지)
3. 모든 부품에 등급을 반드시 표기 (등급 누락 금지)
4. [참조규정ID]는 해당 등급 판정에 사용한 규정 시나리오 ID를 표기 (예: SCENARIO_rail_1)
5. 신뢰도는 조치 방법에 포함하지 않음 (결함정보에만 표기)
6. 각 항목은 한 줄로 작성 (중간 줄바꿈 금지)

**[상세설명]에 반드시 포함할 내용:**
- 발견된 결함의 구체적 상태 (균열 크기, 마모 정도, 변형 상태 등)
- 해당 결함이 왜 위험한지 (안전 영향, 기능 저하, 사고 위험 등)
- 조치 기한과 그 이유 (왜 10일/1개월/즉시인지)
- 구체적인 조치 방법 (어떻게 교체/보수해야 하는지)
- 추가 권장 사항 (인접 부품 점검, 사후 검사 등)

**올바른 예시 (상세 설명 포함):**
- 레일 훼손 (X2, SCENARIO_rail_1): 레일 표면에 깊이 2mm 이상의 균열이 발견되어 하중 분산 기능 저하 우려. 열차 통과 시 진동으로 균열 확대 가능성이 있으므로 10일 이내 해당 구간 레일 교체 필요. 교체 시 선로 차단 후 동일 규격 레일로 교체하고 용접부 비파괴 검사 실시.
- FAST clip 훼손 (X1, SCENARIO_rail_1): 체결장치 클립 2개소에서 탄성 저하 및 변형 확인. 현재 레일 고정력은 유지되나 장기간 방치 시 레일 이탈 위험. 1개월 이내 동일 규격 클립으로 교체하고, 인접 체결장치도 함께 점검 권장.
- 침목 훼손 (O, SCENARIO_rail_1): 침목 표면에 경미한 마모 흔적 발견. 구조적 강도에는 영향 없으나, 향후 열화 진행 가능성 있음. 즉시 교체 불필요, 다음 정기 점검 시 상태 변화 모니터링 필요.
- 조류둥지 (S, SCENARIO_nest_1): 둥지가 전차선 애자와 직접 접촉하여 절연 파괴 및 단락 사고 위험. 즉시 열차 운행 중지 후 둥지 제거 작업 시행. 제거 후 애자 오염 상태 확인 및 필요시 청소.
- 애자 균열 (X2, SCENARIO_insulator_1): 애자 표면에 폭 1mm 이상 균열 발견, 절연 저항 저하로 누설전류 발생 가능. 우천 시 섬락(flashover) 위험 증가하므로 10일 이내 동일 규격 애자로 교체. 교체 전까지 해당 구간 전압 감시 강화.

**잘못된 예시 (절대 금지):**
- 레일 훼손 (X2/X1): ...     ← 복수 등급 금지
- 조류둥지: ...              ← 등급 누락 금지
- 애자 (신뢰도 80.8%): ...   ← 신뢰도 표기 금지
- 레일 (X2): ...             ← 참조규정ID 누락 금지
- 애자 균열 (X2): 10일 이내 교체합니다.  ← 설명 없이 결과만 서술 금지

================================================================================

## 기타 작성 규칙
1. **교체 시기는 위험도 등급과 일치:**
   - E등급 → "교체 불필요" | O등급 → "즉시 교체 불필요"
   - X1등급 → "1개월 이내 교체" | X2등급 → "10일 이내 교체"
   - S등급 → "즉시 교체 (당일 교체 원칙)"

2. **"--" 구분자 사용 금지:**
   - 항목은 "- "로 시작, 설명은 ":"로 연결

================================================================================
★★★ 출력 형식 규칙 - 줄바꿈 금지 (필수) ★★★
================================================================================
다음 패턴에서는 절대로 줄바꿈하지 마세요. 반드시 한 줄로 이어서 작성하세요:

1. **숫자와 단위는 절대 분리 금지:**
   - (O) "26.1°C" | (X) "26.1\\n°C" 또는 "26.\\n1°C"
   - (O) "58%" | (X) "58\\n%"

2. **괄호 안 내용은 반드시 한 줄:**
   - (O) "(흐림, 26.1°C, 58%)" | (X) "(흐림,\\n26.1°C,\\n58%)"
   - (O) "(신뢰도 75.6%)" | (X) "(신뢰도\\n75.6%)"

3. **신뢰도 표기는 한 덩어리:**
   - (O) "신뢰도 54.9%, 52.0%" | (X) "신뢰도\\n54.9%,\\n52.0%"

4. **온도/습도 정보는 한 줄:**
   - (O) "현재 날씨는 흐림, 온도는 26.1°C, 습도는 58%로"
   - (X) "현재 날씨는 흐림, 온도는\\n26.1°C, 습도는\\n58%로"

5. **한글 뒤에 숫자가 오는 경우 줄바꿈 금지:**
   - (O) "온도는 26.1°C" | (X) "온도는\\n26.1°C"
   - (O) "습도는 58%" | (X) "습도는\\n58%"

6. **문장 중간에서 절대 줄바꿈 금지:**
   - 줄바꿈은 오직 리스트 항목(1., 2., 3., -)의 시작에서만 허용
================================================================================

---

[일련번호]
{serial_number}

[철도분류]
{철도분류}

[부품명]
{부품명}

[노선정보]
노선: {노선}
위치: {위치}

[환경정보]
지역: {region_name}
촬영일시: {datetime_str}
날씨: {weather}
온도: {temperature}°C
습도: {humidity}%

[결함정보]
결함유형: (탐지된 결함 유형)
결함상태: (부품별로 줄바꿈하여 작성)
- [부품명] [개수]개소 [상태] (신뢰도: XX.X%): [위험 설명]합니다

[위험도평가]
위험도 등급: (E/O/X1/X2/S 중 하나만 표기, 예: X2)

[위험도등급 판정근거]
(판정 이유를 상세히 작성. 탐지 결과, 신뢰도, 규정 근거 등을 포함)

[참조 규정]
- 규정 시나리오: (참조한 규정 ID와 시나리오 번호, 예: SCENARIO_rail_1)
- 적용 근거: (해당 규정의 어떤 부분을 적용했는지 간략히 설명)

[권장 조치내용]
1. 교체 시기: (위험도 등급에 맞는 기간)
2. 조치 방법:
- [부품명] ([등급], [참조규정ID]): [조치 내용]
3. 주의사항: (환경 조건 고려)

[조치결과]

[작업이력]

---

위 형식을 정확히 따라 보고서를 작성해주세요."""

        return prompt


# 싱글톤 인스턴스
document_generator = DocumentGenerator()
